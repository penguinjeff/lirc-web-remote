<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
<script src="js/0utils.js"></script>
	<script>
var prev=-1;
var prevsub=-1
var remotes_loaded=false;
var activities_loaded=false;
const protocol = window.location.protocol;
console.log(protocol);
var count=0;
var menu='';
var submenu='';

const url = new URL(window.location.href);
menu = url.searchParams.get('menu');
submenu = url.searchParams.get('submenu');
ts = url.searchParams.get('ts');
console.log('menu:'+menu);
console.log('submenu:'+submenu);

function nav()
{
 console.log("count:"+count);
 count++;
 const navigator=document.getElementById("navigator");
 if(navigator.value=='refresh')
 {
  navigator.selectedIndex=prev;
  console.log('Run again with prev value')
  navigator.dispatchEvent(new Event('change'));
  const item=navigator.nextElementSibling;
  item.selectedIndex=prevsub;
  item.dispatchEvent(new Event('change'));
  return;
 }
 const item=navigator.nextElementSibling;
 console.log("menu");
 console.log(navigator.value);
 prev=navigator.selectedIndex
 console.log("submenu");
 console.log(item.value);
 prevsub=item.selectedIndex;
}

var activities_list=['None'];
var remotes_list=['None'];
var activities={};
var remotes={};

function refresh()
{
 remotes_loaded=false;
 activities_loaded=false;
 var rev=Date.now();

 if(protocol=='file:')
 {
  remotes_loaded=true;
  activities_loaded=true;
  create_navigator();
 }
 else
 {
  fetch('remotes/remotes.js?rev='+rev)
   .then(response => response.json()) // Parses the response body as JSON
   .then(data => {
     remotes_loaded=true;
     if(data['remotes']){remotes=data['remotes'];}
     create_navigator();
   })
   .catch(error => {
     console.log('Error fetching JSON:', error); // Handle any errors
     remotes_loaded=true;
     create_navigator();
   });
  fetch('activities/activities.js?rev='+rev)
   .then(response => response.json()) // Parses the response body as JSON
   .then(data => {
     activities_loaded=true;
     if(data['activites']){remotes=data['activities'];}
     create_navigator();
   })
   .catch(error => {
     console.log('Error fetching JSON:', error); // Handle any errors
     activities_loaded=true;
     create_navigator();
   });
  }
}

function update_lists()
{
 remotes_list=Object.keys(remotes);
 if(remotes_list.length===0){remotes_list=['None'];}
 activities_list=Object.keys(activities);
 if(activities_list.length===0){activities_list=['None'];}
// console.log(remotes_list);
// console.log(activities_list);
} 

function create_navigator()
{
 if(!remotes_loaded||!activities_loaded){return}
 update_lists();
 let navigator=document.getElementById("navigator");
 let edits=['Activites','Macros','Modules','Displays'];
 let navigate={'select':{'Activities':activities_list,'Remotes':remotes_list,'Edit':edits,'refresh':['None']},id:'navigator',onchange:'nav()'};
 let elem=createElement(navigate);
 if(navigator){navigator.remove};
 navigator_location.appendChild(elem);
 console.log('prev:'+prev);
 navigator=document.getElementById("navigator");
 if(menu!=null)
 {navigator.selectedIndex=Array.from(navigator.options).map(option => option.value).indexOf(menu);
  navigator.dispatchEvent(new Event('change'));
 }
 if(submenu!=null)
 {
  const item=navigator.nextElementSibling;
  item.selectedIndex=Array.from(item.options).map(option => option.value).indexOf(submenu);
 }
 nav();
}

var navigator_location=createElement({'tag':'div'});
window.addEventListener('load', function () {
 var bodyElement = document.body;
 bodyElement.appendChild(navigator_location);
 refresh()
})

	</script>
</head>
<body>
</body>
</html>
